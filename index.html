<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å«ç”Ÿé—´å€¼æ—¥è¡¨ (é¢„è§ˆå¢å¼ºç‰ˆ)</title>
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
<style>
    body{font-family:"Microsoft YaHei",sans-serif;background-color:#f0f2f5;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;user-select:none}.container{background:white;padding:25px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.08);width:90%;max-width:380px;text-align:center;position:relative}h1{color:#333;margin:0 0 5px 0;font-size:1.4rem}h2{color:#007bff;margin:0 0 20px 0;font-size:1.1rem;font-weight:normal}.date-display{background:#e9ecef;color:#555;padding:8px;border-radius:6px;font-size:.9rem;margin-bottom:20px}.schedule-box{border:1px solid #eee;border-radius:8px;overflow:hidden;position:relative;min-height:150px}.schedule-row{display:flex;border-bottom:1px solid #eee}.schedule-row:last-child{border-bottom:none}.day-col{flex:1;padding:15px 10px;background:#fafafa;color:#666;font-weight:bold;border-right:1px solid #eee;display:flex;align-items:center;justify-content:center}.teacher-col{flex:2;padding:15px 10px;color:#333;font-size:1.1rem;display:flex;align-items:center;justify-content:center}.pause-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.98);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:5}.pause-overlay.active{display:flex}.pause-icon{font-size:3rem;margin-bottom:10px;color:#ffc107}.pause-text{font-size:1.2rem;color:#555;font-weight:bold}.today-highlight .day-col{background:#e3f2fd;color:#007bff}.today-highlight .teacher-col{background:#e3f2fd;color:#007bff;font-weight:bold}.skip-note{font-size:.7rem;color:#f50;display:block;margin-top:2px;font-weight:normal}.status-badge{display:inline-block;margin-top:15px;padding:5px 12px;border-radius:15px;font-size:.85rem}.status-rest{background:#e2e6ea;color:#6c757d}.status-duty{background:#d4edda;color:#155724}.status-paused{background:#fff3cd;color:#856404;border:1px solid #ffeeba}.footer{margin-top:15px;font-size:.75rem;color:#aaa;padding:10px}.admin-modal{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.98);border-radius:12px;z-index:10;flex-direction:column;justify-content:center;align-items:center}.admin-modal.active{display:flex}.op-status{font-size:.85rem;color:#e67e22;font-weight:bold;height:20px;margin-bottom:5px}.toggle-btn{width:85%;padding:12px;border-radius:8px;border:none;color:white;cursor:pointer;margin-bottom:15px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 4px 6px rgba(0,0,0,0.1)}.toggle-main-text{font-size:1.1rem;font-weight:bold;margin-bottom:4px}.toggle-sub-text{font-size:.8rem;opacity:.9;background:rgba(0,0,0,0.15);padding:2px 8px;border-radius:10px}.toggle-on{background:linear-gradient(135deg,#28a745,#20c997)}.toggle-off{background:linear-gradient(135deg,#ffc107,#fd7e14)}.preview-card{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;width:85%;padding:15px;margin-bottom:10px;text-align:left}.preview-row{display:flex;justify-content:space-between;margin-bottom:5px;font-size:1rem;color:#333}.admin-controls{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:85%;margin-bottom:10px}.admin-btn{padding:10px 5px;background:#007bff;color:white;border:none;border-radius:8px;cursor:pointer;font-size:.9rem}.btn-red{background:#dc3545}.btn-green{background:#28a745}.btn-close{background:#343a40;width:85%;padding:12px;margin-top:10px}.loading-mask{position:absolute;top:0;left:0;width:100%;height:100%;background:white;z-index:20;display:flex;justify-content:center;align-items:center;color:#666;font-size:0.9rem;flex-direction:column;}
    
    .debug-info { font-size: 0.7rem; color: #aaa; margin-top: 5px; border-top: 1px dashed #ddd; padding-top: 5px; width: 100%; text-align: center;}
    /* æ–°å¢é¢„è§ˆåˆ—è¡¨æ ·å¼ */
    .preview-list { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
    .preview-item { display: flex; justify-content: space-between; font-size: 0.95rem; color: #555; margin-bottom: 4px; }
    .preview-item b { color: #333; }
</style>
</head>
<body>

<div class="container">
    <div id="loadingMask" class="loading-mask">
        <div style="font-size:2em;margin-bottom:10px">â˜ï¸</div>
        æ­£åœ¨è¿æ¥äº‘ç«¯...
    </div>

    <h1>ğŸš½ å«ç”Ÿé—´å€¼æ—¥è¡¨</h1>
    <h2 id="roundInfo">æ’ç­è®¡ç®—ä¸­...</h2>
    <div class="date-display" id="dateInfo"></div>

    <div class="schedule-box">
        <div id="pauseOverlay" class="pause-overlay">
            <div class="pause-icon">â˜•</div>
            <div class="pause-text">å‡æœŸæš‚åœä¸­</div>
            <div style="font-size:0.9rem; color:#999; margin-top:5px;">ç³»ç»Ÿå·²ä¼‘çœ ï¼Œæ’ç­é¡ºå»¶</div>
        </div>
        <div class="schedule-row" id="row-wed"><div class="day-col">å‘¨ä¸‰</div><div class="teacher-col" id="t-wed">--</div></div>
        <div class="schedule-row" id="row-thu"><div class="day-col">å‘¨å››</div><div class="teacher-col" id="t-thu">--</div></div>
        <div class="schedule-row" id="row-fri"><div class="day-col">å‘¨äº”</div><div class="teacher-col" id="t-fri">--</div></div>
    </div>

    <div id="statusBadge" class="status-badge"></div>

    <div class="footer" id="triggerZone">
        æ’ç­é¡ºåºï¼šçŸ³â†’ä¸â†’èŒâ†’ç¬‘â†’ä½•â†’åº·â†’éŸ©<br>
        (ç®¡ç†å‘˜ç‚¹å‡»æ­¤å¤„è¿›å…¥äº‘æ§å°)
    </div>

    <div class="admin-modal" id="adminPanel">
        <h3 style="margin:15px 0 10px 0;">ğŸ›  äº‘ç«¯æ§åˆ¶å°</h3>
        
        <button id="mainToggleBtn" class="toggle-btn" onclick="toggleCloudPause()">
            <span class="toggle-main-text">è¯»å–ä¸­...</span>
        </button>

        <div class="preview-card">
            <div class="preview-title">æœ¬æ¬¡å¾®è°ƒï¼š<b id="disp-session-offset" style="color:#e67e22;font-size:1.4em">0</b></div>
            
            <div class="preview-list">
                <div class="preview-item"><span>å‘¨ä¸‰:</span> <b id="pre-wed">--</b></div>
                <div class="preview-item"><span>å‘¨å››:</span> <b id="pre-thu">--</b></div>
                <div class="preview-item"><span>å‘¨äº”:</span> <b id="pre-fri">--</b></div>
            </div>

            <div class="debug-info">åå°æ€»åç§»å€¼ (Real Offset)ï¼š<span id="disp-real-offset">--</span></div>
        </div>

        <div class="admin-controls">
            <button class="admin-btn btn-red" onclick="adjustRelative(-1)">âª å¾€å›ä¸€ä½</button>
            <button class="admin-btn btn-green" onclick="adjustRelative(1)">å¾€åä¸€ä½ â©</button>
            <button class="admin-btn btn-red" onclick="adjustRelative(-3)">âª å¾€å›ä¸€å‘¨</button>
            <button class="admin-btn btn-green" onclick="adjustRelative(3)"> å¾€åä¸€å‘¨ â©</button>
        </div>
        
        <div id="opStatus" class="op-status"></div>
        <button class="admin-btn btn-close" onclick="closeAdmin()">å…³é—­ / è¿”å›</button>
    </div>
</div>

<script>
    const LC_APP_ID = "1OHISQN99CFPAQn6K0aZQRpm-gzGzoHsz"; 
    const LC_APP_KEY = "y0pWlEyJrFr3P4LYu7GkIYfK";
    const LC_SERVER_URL = "https://1ohisqn9.lc-cn-n1-shared.com"; 

    const DB_CLASS_NAME = 'RosterData';

    const teachers = ["çŸ³è€å¸ˆ", "ä¸è€å¸ˆ", "èŒèŒè€å¸ˆ", "ç¬‘ç¬‘è€å¸ˆ", "ä½•è€å¸ˆ", "åº·åº·è€å¸ˆ", "éŸ©è€å¸ˆ"];
    const anchorDate = new Date(2026, 0, 7); 
    const defaultStartIdx = 4; 

    let globalState = { isPaused: false, offset: 0, objectId: null };
    let sessionDelta = 0; 
    let isCloudReady = false;

    if (typeof AV === 'undefined') {
        alert("äº‘ç«¯è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
        document.getElementById('loadingMask').innerText = "è„šæœ¬åŠ è½½å¤±è´¥";
    } else {
        try {
            AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURLs: LC_SERVER_URL });
            isCloudReady = true;
        } catch(e) { console.error(e); }
    }

    async function fetchCloudData() {
        if(!isCloudReady) return;
        const query = new AV.Query(DB_CLASS_NAME);
        query.descending('updatedAt');
        query.limit(1);

        try {
            const results = await query.find();
            if (results.length > 0) {
                const data = results[0];
                globalState.isPaused = data.get('isPaused');
                globalState.offset = Number(data.get('offset')) || 0;
                globalState.objectId = data.id;
            } else {
                const Config = AV.Object.extend(DB_CLASS_NAME);
                const config = new Config();
                config.set('isPaused', false);
                config.set('offset', 0);
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                config.setACL(acl);
                const saved = await config.save();
                globalState.objectId = saved.id;
            }
            document.getElementById('loadingMask').style.display = 'none';
            render();
        } catch (error) {
            console.error(error);
            document.getElementById('loadingMask').innerHTML = 
                `è¿æ¥å¤±è´¥<br><span style="font-size:0.6em">${error.message}</span><br><button onclick="location.reload()" style="margin-top:10px">é‡è¯•</button>`;
        }
    }

    async function saveToCloud() {
        if(!globalState.objectId) return;

        const opDiv = document.getElementById('opStatus');
        opDiv.innerText = "â³ æ­£åœ¨ä¿å­˜...";
        opDiv.style.color = "orange";
        toggleButtons(true);

        const config = AV.Object.createWithoutData(DB_CLASS_NAME, globalState.objectId);
        config.set('isPaused', globalState.isPaused);
        config.set('offset', Number(globalState.offset)); 
        
        try {
            await config.save();
            opDiv.innerText = "âœ… ä¿å­˜æˆåŠŸï¼";
            opDiv.style.color = "green";
            render(); 
        } catch (error) {
            opDiv.innerText = "âŒ ä¿å­˜å¤±è´¥";
            opDiv.style.color = "red";
            alert("ä¿å­˜å¤±è´¥ï¼š" + error.message);
        } finally {
            toggleButtons(false);
            setTimeout(() => { 
                if(opDiv.innerText.includes("æˆåŠŸ")) opDiv.innerText=""; 
            }, 2000);
        }
    }

    function toggleButtons(disabled) {
        const btns = document.querySelectorAll('.admin-btn, .toggle-btn');
        btns.forEach(btn => btn.disabled = disabled);
    }

    function toggleCloudPause() {
        globalState.isPaused = !globalState.isPaused;
        saveToCloud(); 
    }

    function adjustRelative(delta) {
        globalState.offset = globalState.offset + delta;
        sessionDelta = sessionDelta + delta;
        saveToCloud(); 
    }

    function calculateRoster() {
        const today = new Date();
        const offset = globalState.offset; 
        const getWed = (d) => {
            let date = new Date(d); date.setHours(0,0,0,0);
            let day = date.getDay(); 
            let diff = 3 - day; 
            date.setDate(date.getDate() + diff);
            return date;
        };
        const baseWed = getWed(anchorDate);
        const currentWed = getWed(today);
        const diffWeeks = Math.round((currentWed - baseWed) / (1000 * 60 * 60 * 24 * 7));

        let startPointer = defaultStartIdx + offset;
        let weeksToRun = diffWeeks > 0 ? diffWeeks : 0;
        let ptr = startPointer;

        for (let i = 0; i <= weeksToRun; i++) {
            let weekRoster = [];
            let p1 = ((ptr % 7) + 7) % 7; weekRoster.push({ name: teachers[p1], rawName: teachers[p1], note: "" }); ptr++;
            let p2 = ((ptr % 7) + 7) % 7; weekRoster.push({ name: teachers[p2], rawName: teachers[p2], note: "" }); ptr++;
            let p3 = ((ptr % 7) + 7) % 7;
            if (teachers[p3] === "çŸ³è€å¸ˆ") { 
                ptr++; 
                let pReal = ((ptr % 7) + 7) % 7; 
                weekRoster.push({ name: teachers[pReal], rawName: teachers[pReal], note: "<span class='skip-note'>(çŸ³é¡ºå»¶)</span>" }); 
                ptr = p3; 
            } else { 
                weekRoster.push({ name: teachers[p3], rawName: teachers[p3], note: "" }); 
                ptr++; 
            }
            if (i === weeksToRun) return weekRoster;
        }
    }

    function render() {
        const today = new Date();
        const roster = calculateRoster();
        const weekDay = today.getDay();
        const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        
        document.getElementById('dateInfo').innerText = dateStr;
        document.getElementById('roundInfo').innerText = "æ™ºèƒ½æ’ç­ç³»ç»Ÿ (äº‘åŒæ­¥ç‰ˆ)";

        const isPaused = globalState.isPaused;
        const overlay = document.getElementById('pauseOverlay');
        const badge = document.getElementById('statusBadge');

        if (isPaused) {
            overlay.classList.add('active');
            badge.className = 'status-badge status-paused';
            badge.innerText = "ğŸ›Œ ç³»ç»Ÿä¼‘çœ ä¸­...";
        } else {
            overlay.classList.remove('active');
            if(roster && roster.length === 3) {
                document.getElementById('t-wed').innerHTML = roster[0].name + roster[0].note;
                document.getElementById('t-thu').innerHTML = roster[1].name + roster[1].note;
                document.getElementById('t-fri').innerHTML = roster[2].name + roster[2].note;
                const rows = {3: 'row-wed', 4: 'row-thu', 5: 'row-fri'};
                const names = {3: roster[0].rawName, 4: roster[1].rawName, 5: roster[2].rawName};
                document.querySelectorAll('.schedule-row').forEach(el => el.classList.remove('today-highlight'));
                if (weekDay >= 3 && weekDay <= 5) {
                    document.getElementById(rows[weekDay]).classList.add('today-highlight');
                    badge.className = 'status-badge status-duty';
                    badge.innerText = `ğŸ§¹ ä»Šæ—¥å€¼æ—¥ï¼š${names[weekDay]}`;
                } else {
                    badge.className = 'status-badge status-rest';
                    badge.innerText = "â˜• ä»Šæ—¥æ— å€¼æ—¥å®‰æ’ (ä¼‘æ¯)";
                }
            }
        }
        updateAdminView();
    }

    function updateAdminView() {
        const btn = document.getElementById('mainToggleBtn');
        const isPaused = globalState.isPaused;
        
        // æ˜¾ç¤ºå¾®è°ƒæ•°
        document.getElementById('disp-session-offset').innerText = (sessionDelta > 0 ? "+" : "") + sessionDelta;
        // æ˜¾ç¤ºçœŸå®åå°å€¼ï¼ˆå°å­—ï¼‰
        document.getElementById('disp-real-offset').innerText = globalState.offset;

        // ğŸŸ¢ æ ¸å¿ƒåŠŸèƒ½ï¼šæ›´æ–°é¢„è§ˆç•Œé¢
        const roster = calculateRoster();
        if(roster && roster.length === 3) {
            document.getElementById('pre-wed').innerText = roster[0].rawName;
            document.getElementById('pre-thu').innerText = roster[1].rawName;
            let friText = roster[2].rawName;
            if (roster[2].note.includes("é¡ºå»¶")) friText += " (æ›¿è¡¥)";
            document.getElementById('pre-fri').innerText = friText;
        }
        
        if (isPaused) {
            btn.className = 'toggle-btn toggle-on';
            btn.innerHTML = `<span class="toggle-main-text">â–¶ï¸ ç»“æŸå‡æœŸ (æ¢å¤æ’ç­)</span><span class="toggle-sub-text">å½“å‰çŠ¶æ€ï¼šğŸ”´ å·²æš‚åœ (å‡æœŸæ¨¡å¼)</span>`;
        } else {
            btn.className = 'toggle-btn toggle-off';
            btn.innerHTML = `<span class="toggle-main-text">â¸ï¸ å¼€å¯å‡æœŸæ¨¡å¼ (æš‚åœ)</span><span class="toggle-sub-text">å½“å‰çŠ¶æ€ï¼šğŸŸ¢ æ­£å¸¸è¿è¡Œä¸­</span>`;
        }
    }

    let clickCount = 0; let timer;
    document.getElementById('triggerZone').addEventListener('click', () => {
        clickCount++; clearTimeout(timer); timer = setTimeout(() => clickCount=0, 2000);
        if(clickCount===5) { 
            clickCount = 0; 
            if(prompt("è¾“å…¥ç®¡ç†å‘˜å¯†ç ") === "888") {
                sessionDelta = 0; // æ‰“å¼€æ—¶å½’é›¶å¾®è°ƒæ•°
                updateAdminView();
                document.getElementById('adminPanel').classList.add('active'); 
            }
        }
    });
    function closeAdmin() { document.getElementById('adminPanel').classList.remove('active'); }

    // ğŸš€ å¯åŠ¨ï¼
    fetchCloudData(); 
</script>
</body>
</html>
